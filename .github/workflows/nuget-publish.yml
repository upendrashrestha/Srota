name: Publish Srota to NuGet (Trusted Publishing)

on:
  push:
    tags:
      - "v*"

permissions:
  id-token: write     # Required for OIDC
  contents: read
  packages: write

jobs:
  build-pack-publish:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: "8.x"

   # Restore
    - name: Restore
      run: dotnet restore
    
    # Build
    - name: Build
      run: dotnet build --configuration Release --no-restore
    
    # Test
    - name: Test
      run: |
        TEST_PROJECTS=$(find tests -name "*.csproj" 2>/dev/null || true)
        if [ -n "$TEST_PROJECTS" ]; then
          dotnet test --no-build --configuration Release --verbosity normal
        else
          echo "No tests found"
        fi
    
    # Version
    - name: Get Version
      id: version
      run: |
        if [[ $GITHUB_REF == refs/tags/* ]]; then
          VERSION=${GITHUB_REF#refs/tags/v}
        else
          VERSION="1.0.0-preview.$(date +%Y%m%d%H%M%S)"
        fi
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Package version: $VERSION"
    
    # Pack
    - name: Pack Projects
      run: |
        mkdir -p ./nupkgs
        
        # Pack Srota.Core
        if [ -f "src/Srota.Core/Srota.Core.csproj" ]; then
          echo "Packing Srota.Core..."
          dotnet pack src/Srota.Core/Srota.Core.csproj \
            -c Release \
            -o ./nupkgs \
            --no-build \
            /p:PackageVersion=${{ steps.version.outputs.version }}
        fi
        
        echo "=== Packages Created ==="
        ls -lh ./nupkgs/

    - name: Publish to NuGet via Trusted Publishing
      uses: NuGet/NuGet-Trusted-Publisher@v1
      with:
        nuget-folder: "./nupkgs"
